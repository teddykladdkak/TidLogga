<!DOCTYPE html>
<html>
<head>
	<title>TidLogga</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="yes" name="mobile-web-app-capable" />
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=0.6667, user-scalable=no" name="viewport" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<script type="application/javascript" src="config.js"></script>
	<script type="text/javascript">
		function load(){
			var logininput = document.getElementById('idnamn');
				logininput.focus();
				logininput.select();
			for (var i = 0; i < config.elemtohide.length; i++){
				document.getElementById(config.elemtohide[i]).setAttribute('style', 'display: none;');
			};
		};
		function removechilds(parent){while (parent.hasChildNodes()) {parent.removeChild(parent.firstChild);};};
		function showhide(hide, show){if(hide == 'none'){}else{document.getElementById(hide).setAttribute('style', 'display: none;');};if(show == 'none'){}else{document.getElementById(show).removeAttribute('style');};};
		var removeError;
		function adderror(id, text){
			var error = document.getElementById(id);
				removeerror(id);
				var errortext = document.createTextNode(text);
				error.appendChild(errortext);
				clearTimeout(removeError);
				removeError = setTimeout(function(){ removeerror(id); }, 3000);
		};
		function removeerror(id){
			var error = document.getElementById(id);
			removechilds(error);
		};
		function disablebuttons(id){
			var utelem = document.getElementsByClassName(id);
			for (var i = utelem.length - 1; i >= 0; i--) {
				var klickfunc = utelem[i].getAttribute('onclick');
				if(!klickfunc){}else{
					utelem[i].setAttribute('data-onclick', klickfunc);
					utelem[i].disabled = true;
				};
			};
		};
		function enablebuttons(id){
			var inelem = document.getElementsByClassName(id);
			for (var i = inelem.length - 1; i >= 0; i--) {
				var klickfunc = inelem[i].getAttribute('data-onclick');
				if(!klickfunc){}else{
					inelem[i].setAttribute('onclick', klickfunc);
					inelem[i].disabled = false;
				};
			};
		};
		function addzero(number){if(number <= 9){return "0" + number;}else{return number;};};
		function timebetween(start, stop, millisec){
			if(!millisec){
				var sekunder = parseInt(stop) / 1000 - parseInt(start) / 1000;
			}else{
				var sekunder = parseInt(millisec) / 1000;
			};
			var t = Math.floor(sekunder / 3600);
			var m = Math.floor((sekunder / 60) - (t * 60));
			var s = Math.floor(sekunder - (m * 60) - (t * 3600));
			return {"t": t, "m": m, "s": s};
		};
		function backtostandard(element, standard){removechilds(element);var text = document.createTextNode(standard);element.appendChild(text);};
		var countinterval;
		function startcount(){
			var tidraknare = document.getElementById('tid');
			var inmilisec = tidraknare.getAttribute('data-milisec');
			var numilisec = getDate().milisec;
			var timecalc = timebetween(inmilisec, numilisec);
			removechilds(tidraknare);
			var tidraknaretext = document.createTextNode(addzero(timecalc.t) + ':' + addzero(timecalc.m) + ':' + addzero(timecalc.s));
			tidraknare.appendChild(tidraknaretext);
		};
		function getDate(dateannan, timeannan, milisecsave){
			if(!dateannan && !timeannan && !milisecsave){
				var date = new Date();
			}else if(!milisecsave){
				var annatdatum = dateannan.split('-');
				var annattid = timeannan.split(':');
				var date = new Date(annatdatum[0], annatdatum[1] - 1, annatdatum[2], annattid[0], annattid[1]);
			}else{
				var date = new Date(parseInt(milisecsave));
			};
			var y = date.getFullYear();
			var m = date.getMonth() + 1;
			var d = date.getDate();
			var h = date.getHours();
			var mm = date.getMinutes();
			var milisec = date.getTime();
			var datum = y + '-' + addzero(m) + '-' + addzero(d);
			var tid = addzero(h) + ':' + addzero(mm);
			return {"datum": datum, "tid": tid, "milisec": milisec};
		};
		function tillbakatillprojekt(){
			clearInterval(countinterval);
			var projektnamn = document.getElementById('projektnamn');
				backtostandard(projektnamn, 'XXXXXXXXX');
				showhide('projektnamn', 'none');
			var intid = document.getElementById('intid');
				backtostandard(intid, 'XX:XX');
			var tid = document.getElementById('tid');
				backtostandard(tid, 'XX:XX:XX');
				tid.removeAttribute('data-milisec');
				tid.removeAttribute('data-projektid');
			showhide('klocka', 'projekt');
		};
		function annantid(todo){
			showhide('klocka', 'klockaannantid');
			var button = document.getElementById('annantidbutton');
			if(todo == 'in'){
				button.setAttribute('value', 'Klocka in');
				button.setAttribute('onclick', 'startclock("annat")');
			}else if(todo == 'ut'){
				button.setAttribute('value', 'Klocka ut');
				button.setAttribute('onclick', 'stopclock("annat");');
			}else{
				console.log('Något gick fel i "annantid()".');
			};
			var datum = document.getElementById('dateannan');
				datum.value = getDate().datum;
			var tid = document.getElementById('timeannan');
				tid.value = getDate().tid;
		};
		function numbertotext(num){var numsplit = num.split('');var result = [];for (var i = numsplit.length - 1; i >= 0; i--) {if(numsplit[i] == '0'){result.push('noll');}else if(numsplit[i] == '1'){result.push('ett');}else if(numsplit[i] == '2'){result.push('tva');}else if(numsplit[i] == '3'){result.push('tre');}else if(numsplit[i] == '4'){result.push('fyra');}else if(numsplit[i] == '5'){result.push('fem');}else if(numsplit[i] == '6'){result.push('sex');}else if(numsplit[i] == '7'){result.push('sju');}else if(numsplit[i] == '8'){result.push('atta');}else if(numsplit[i] == '9'){result.push('nio');}else{result.push('vetej');};};return result.join('');};
		function manadtotext(num){return config.manader[parseInt(num) - 1]};
		function loggsort(loggdata) {
			var allmillisec = [];
			for (var i = loggdata.length - 1; i >= 0; i--) {
				if(!loggdata[i].ut){
					var valtoadd = loggdata[i].in.milisec;
					var zerostoadd = loggdata[i].in.milisec.toString().split('');
					for (var a = zerostoadd.length - 1; a >= 0; a--) {
						var valtoadd = valtoadd + '0';
					};
				}else{
					var valtoadd = loggdata[i].in.milisec + '' + loggdata[i].ut.milisec;	
				};
				allmillisec.push(valtoadd);
			};
			allmillisec.sort();
			var sortedarray = [];
			for (var i = allmillisec.length - 1; i >= 0; i--) {
				var ammount = allmillisec[i].toString().length;
				var half =  ammount / 2;
				var inmillisec = allmillisec[i].slice(0, half);
				var utmillisec = allmillisec[i].slice(half, ammount);
				for (var a = loggdata.length - 1; a >= 0; a--) {
					if(loggdata[a].in.milisec == inmillisec){
						if(parseInt(utmillisec) == 0){
							sortedarray.push(loggdata[a]);
						}else if(loggdata[a].ut.milisec == utmillisec){
							sortedarray.push(loggdata[a]);
						};
					};
				};
			};
			return sortedarray;
		};
		function checkkey(e, id, focus){
			if (event.which == 13 || event.keyCode == 13) {
				document.getElementById(id).click();
				var selectelem = document.getElementById(focus);
					selectelem.focus();
			};
		};
		function addbrake(parent){
			var brake = document.createElement('br');
			parent.appendChild(brake);
		};
	</script>
	<style type="text/css">
		#header {
			font-size: 20px;
			vertical-align: top;
			text-align: center;
			width: 100%;
		}
		#head {
			font-weight: bold;
			font-family: verdana;
			text-align: center;
		}
		.table {
			display: table;
		}
		.tr {
			display: table-row;
		}
		.td{
			display: table-cell;
		}
		input, select, #klockadata, p {
			zoom: 1.5;
			margin: 5px;
		}
		#login, #projekt, #klocka, #klockaannantid, #loggwrapper, #loggedit, #skrivut{
			border: solid #000 3px;
		}
		#namn {
			text-align: left;
		}
		#projektnamn {
			text-align: right;
		}
		#loggwrapper table{
			margin: 5px 10px 10px 10px;
		}
		.checkboxwrapper{
			display: inline-block;
			white-space: nowrap;
		}
		#loggwrapper table{
			margin-bottom: 10px;
		}
		#loggwrapper table, #loggwrapper table td, #skrivutpapper table, #skrivutpapper table td{
			border-collapse: collapse;
			border: solid 2px #000;
		}
		#skrivutpapper table, #skrivutpapper table tr{
			width: 100%;
		}
		#skrivutpapper table tbody tr{
			text-align: center;
		}
		#skrivutpapper table thead tr{
			font-weight: bold;
			border-bottom: solid 3px #000;
		}
		#skrivutpapper table tbody tr td.projektnamn, #skrivutpapper table thead tr td:nth-child(1){
			text-align: left;
			border-right: solid 3px #000;
		}
		#skrivutpapper table tbody tr.topborder{
			border-top: solid 3px #000;
		}
		/*#skrivutpapper table tbody tr:nth-child(0), #skrivutpapper table tr:nth-child(1){
			text-align: left;
		}*/
		@media print { 
			#login, #projekt, #klocka, #klockaannantid, #loggwrapper, #loggedit, #skrivut, #namn, #projektnamn, #head{
				display: none;
			}
			#skrivutpapper{
				display: block!important;
			}
			#skrivutpapper table{
				border: solid #000 3px;
			}
		}
	</style>
</head>
<body onload="load();">
	<div id="head">TidLogga</div>
	<div id="header" class="table">
		<div class="tr">
			<div id="namn" class="td">Välkommen XXXX</div>
			<div id="projektnamn" class="td">XXXXXXXXX</div>
		</div>
	</div>
	<div id="login">
		<input type="text" id="idnamn" onkeydown="checkkey(event, 'loginbutton', 'listaprojekt');" placeholder="VGR ID"><span id="namnstatus"></span><br/>
		<input type="button" value="Logga In" id="loginbutton" onclick="loggain();">
	</div>
	<div id="projekt">
		<select id="listaprojekt">
			<option value="none">Välj Projekt</option>
		</select><br/>
		<input type="button" value="Klocka" onclick="valjprojekt();"><input type="button" value="Logg" onclick="getlogg();"><input type="button" value="Skriv ut..." onclick="loadskrivut();">
	</div>
	<div id="klocka">
		<div id="klockadata">
			<span id="intid">XX:XX</span> <span id="tid">XX:XX:XX</span>
		</div>
		<input type="button" value="Klocka in" class="in" onclick="startclock('nu')"><input type="button" value="Klocka ut" class="ut" onclick="stopclock('nu');">
		<div class="table">
			<div class="tr">
				<div class="td">
					<input type="button" class="in" value="Klocka in annan tid" onclick="annantid('in');"><input type="button" class="ut" value="Klocka ut annan tid" onclick="annantid('ut');">
				</div>
				<div class="td">
					<input type="button" value="Tillbaka" onclick="tillbakatillprojekt();">
				</div>
			</div>
		</div>
	</div>
	<div id="klockaannantid">
		<input type="date" id="dateannan"><input type="time" id="timeannan"><span id="datumstatus"></span><br/>
		<input type="button" id="annantidbutton" value="Klocka in/ut" onclick="startclock('annat')"><input type="button" id="annantidbutton" value="Avbryt" onclick="showhide('klockaannantid', 'klocka');">
	</div>
	<div id="loggwrapper">
		
	</div>
	<div id="loggedit">
		<p>In stämpling</p>
		<input type="date" id="loggeditindat"><br/>
		<input type="time" id="loggeditintime">
		<p>Ut stämpling</p>
		<input type="date" id="loggeditutdat"><br/>
		<input type="time" id="loggedituttime"><br/>
		<input type="button" value="Spara" onclick="sendedit();"><input type="button" value="Avbryt" onclick="avbrytedit();">
	</div>
	<div id="skrivut">
			
	</div>
	<div id="skrivutpapper">
			
	</div>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		//Tar server id enbart för att koppla till socket
		var geturl = window.location.href.replace('http://', '').split('/')[0];
		
		//Lyssnar om server säger något
		var socket = io.connect(geturl);

		// Visar i console log status från server
		socket.on('message', function(message) {
			console.log(message);
		});

		function loggain(){
			var nameinput = document.getElementById('idnamn').value;
			socket.emit('checkuser', nameinput);
		};

		socket.on('anvandare', function(responsdata) {
			document.getElementById('tid').setAttribute('data-vgrid', responsdata.vgrid);
			var namn = document.getElementById('namn');
				removechilds(namn);
				var namntext = document.createTextNode('Välkommen ' + responsdata.namn);
				namn.appendChild(namntext);
			var listaprojekt = document.getElementById('listaprojekt');
			for (var a = 0; a < responsdata.projekt.length; a++){
				var option = document.createElement('option');
					option.setAttribute('value', responsdata.projekt[a]);
					var optiontext = document.createTextNode(config.projekt[responsdata.projekt[a]].namn);
					option.appendChild(optiontext);
				listaprojekt.appendChild(option);
			};
			showhide('none', 'namn');
			showhide('login', 'projekt');
		});

		socket.on('erroranvandare', function(message) {
			adderror('namnstatus', 'Användarnamn kunde inte hittas!');
			console.log('Användarnamn kunde inte hittas!');
		});

		function valjprojekt(){
			var select = document.getElementById('listaprojekt');
			var vgrid = document.getElementById('tid').getAttribute('data-vgrid');
			if(select.value == 'none'){}else{
				socket.emit('checkprojekt', {"projekt": select.value, "vgrid": vgrid, "getall": false, "checkaktiv": true});
			};
		};

		socket.on('svarprojekt', function(responsdata) {
			var tidraknare = document.getElementById('tid');
				tidraknare.setAttribute('data-projektid', responsdata.projekt);
				var projektnamn = document.getElementById('projektnamn');
					removechilds(projektnamn);
					var projektnamntext = document.createTextNode(config.projekt[responsdata.projekt].namn);
					projektnamn.appendChild(projektnamntext);
				showhide('none', 'projektnamn');
				showhide('projekt', 'klocka');
			if(responsdata.svar == 'none'){
				enablebuttons('in')
				disablebuttons('ut')
			}else{
				startclock('save', responsdata.svar.milisec);
			};
		});

		function startclock(todo, startmilisec){
			disablebuttons('ut');
			disablebuttons('in');
			var save = false;
			if(todo == 'nu'){
				var datum = getDate();
			}else if(todo == 'annat'){
				var dateannan = document.getElementById('dateannan').value;
				var timeannan = document.getElementById('timeannan').value;
				var datum = getDate(dateannan, timeannan);
				showhide('klockaannantid', 'klocka');
			}else if(todo == 'save'){
				var datum = getDate('', '', startmilisec);
				var save = true;
			};
			var tidraknare = document.getElementById('tid');
			var projektid = tidraknare.getAttribute('data-projektid');
			var vgrid = tidraknare.getAttribute('data-vgrid');
			socket.emit('klockain', {"projekt": projektid, "vgrid": vgrid, "datum": datum, "save": save});
		};

		socket.on('startaklocka', function(inklockdata) {
			enablebuttons('ut');
			disablebuttons('in');
			var tidwrapper = document.getElementById('intid');
			removechilds(tidwrapper);
				var tidwrappertext = document.createTextNode(inklockdata.datum.tid);
				tidwrapper.appendChild(tidwrappertext);
			var tidraknare = document.getElementById('tid');
				tidraknare.setAttribute('data-milisec', inklockdata.datum.milisec);
			clearInterval(countinterval);
			startcount();
			countinterval = setInterval(function(){ startcount(); }, 1000);
		});


		function stopclock(todo){
			if(todo == 'nu'){
				var datum = getDate();
			}else if(todo == 'annat'){
				var dateannan = document.getElementById('dateannan').value;
				var timeannan = document.getElementById('timeannan').value;
				var datum = getDate(dateannan, timeannan);
			}else{
				console.log('Något gick fel i "stopclock()".');
			};
			var startmilisec = document.getElementById('tid').getAttribute('data-milisec');
			if(datum.milisec <= startmilisec){
				adderror('datumstatus', 'Du kan inte kocka ut innan du klockade in!');
			}else{
				disablebuttons('ut');
				disablebuttons('in');
				clearInterval(countinterval);
				showhide('klockaannantid', 'klocka');
				var tidraknare = document.getElementById('tid');
				var projektid = tidraknare.getAttribute('data-projektid');
				var startdatum = getDate('', '', tidraknare.getAttribute('data-milisec')).datum;
				var vgrid = tidraknare.getAttribute('data-vgrid');
				socket.emit('stopklocka', {"projekt": projektid, "vgrid": vgrid, "datum": datum, "startdatum": startdatum});
			};
		};

		socket.on('stopklocka', function(inklockdata) {
			enablebuttons('in');
			disablebuttons('ut');
		});

		function getlogg(specielltdatum){
			var select = document.getElementById('listaprojekt');
			var vgrid = document.getElementById('tid').getAttribute('data-vgrid');
			if(select.value == 'none'){}else{
				var loggwrapper = document.getElementById('loggwrapper');
				removechilds(loggwrapper);
				if(!specielltdatum){
					var datum = 'none';
				}else{
					var datum = specielltdatum;
				};
				socket.emit('checkprojekt', {"projekt": select.value, "datum": datum, "vgrid": vgrid, "getall": true, "checkaktiv": false});
			};
		};
		function loggandramanad(element){
			getlogg(element.value);
		};
		socket.on('sendlogg', function(loggdata) {
			if(!loggdata.mothtoload){}else{
				var projektnamn = document.getElementById('projektnamn');
					removechilds(projektnamn);
					var projektnamntext = document.createTextNode(config.projekt[loggdata.projekt].namn);
					projektnamn.appendChild(projektnamntext);
				showhide('none', 'projektnamn');
				var loggwrapper = document.getElementById('loggwrapper');
					var tillbaka = document.createElement('input');
						tillbaka.setAttribute('type', 'button');
						tillbaka.setAttribute('value', 'Tillbaka');
						tillbaka.setAttribute('onclick', 'backfromlogg();');
					loggwrapper.appendChild(tillbaka);
				var month = document.createElement('select');
					month.setAttribute('onchange', 'loggandramanad(this);');
				for (var a = loggdata.mothtoload.length - 1; a >= 0; a--) {
					var option = document.createElement('option');
						option.setAttribute('value', loggdata.mothtoload[a]);
						var optiontext = document.createTextNode(loggdata.mothtoload[a]);
						option.appendChild(optiontext);
					month.appendChild(option);
				};
				loggwrapper.appendChild(month);
				var datumsplit = loggdata.datum.split('-');
				month.value = datumsplit[0] + '-' + datumsplit[1];
				var loggsorted = loggsort(loggdata.svar.data);
				var tableelem = document.createElement('table');
				for (var i = 0; i < loggsorted.length; i++){
					addlogglist(loggsorted[i], tableelem, loggdata.projekt, loggdata.vgrid);
				};
				loggwrapper.appendChild(tableelem);
				showhide('projekt', 'loggwrapper');
			};
		});
		function backfromlogg(){
			var projektnamn = document.getElementById('projektnamn');
				removechilds(projektnamn);
			showhide('projektnamn', 'none');
			showhide("loggwrapper", "projekt");
		};
		function addlogglist(loggdata, tableelem, projektid, vgrid){
			var line = document.createElement('tr');
				line.setAttribute('data-vgrid', vgrid);
				line.setAttribute('data-projektid', projektid);
				line.setAttribute('data-milisecin', loggdata.in.milisec);
			if(!loggdata.ut){
				line.setAttribute('data-milisecut', 'none');
			}else{
				line.setAttribute('data-milisecut', loggdata.ut.milisec);
			};
				var tddatum = document.createElement('td');
					var tddatumtext = document.createTextNode(loggdata.in.datum);
					tddatum.appendChild(tddatumtext);
				line.appendChild(tddatum);
				var intid = document.createElement('td');
					var intidtext = document.createTextNode(loggdata.in.tid);
					intid.appendChild(intidtext);
				line.appendChild(intid);
				var uttid = document.createElement('td');
				if(!loggdata.ut){}else{
					var uttidtext = document.createTextNode(loggdata.ut.tid);
					uttid.appendChild(uttidtext);
				};
				line.appendChild(uttid);
				var totaltid = document.createElement('td');
				if(!loggdata.ut){}else{
					var time = timebetween(loggdata.in.milisec, loggdata.ut.milisec, '');
					var totaltidtext = document.createTextNode(addzero(time.t) + ':' + addzero(time.m) + ':' + addzero(time.s));
					totaltid.appendChild(totaltidtext);
				};
				line.appendChild(totaltid);
				var remove = document.createElement('td');
					var removeinput = document.createElement('img');
						removeinput.setAttribute('src', 'img/trash.png');
						removeinput.setAttribute('value', 'Ta bort');
						removeinput.setAttribute('class', 'loggbutton');
						removeinput.setAttribute('onclick', 'removesegment(this);');
					remove.appendChild(removeinput);
					if(!loggdata.ut){}else{
						var editinput = document.createElement('img');
							editinput.setAttribute('src', 'img/edit.png');
							editinput.setAttribute('value', 'Edit');
							editinput.setAttribute('class', 'loggbutton');
							editinput.setAttribute('onclick', 'showedit(this);');
						remove.appendChild(editinput);
					};
				line.appendChild(remove);
			tableelem.appendChild(line);
		};
		function removesegment(element){
			var millisecin = element.parentElement.parentElement.getAttribute('data-milisecin');
			var millisecut = element.parentElement.parentElement.getAttribute('data-milisecut');
			var vgrid = element.parentElement.parentElement.getAttribute('data-vgrid');
			var projektid = element.parentElement.parentElement.getAttribute('data-projektid');
			var datum = getDate('', '', millisecin).datum;
			socket.emit('removesegment', {"millisecin": millisecin, "millisecut": millisecut, "vgrid": vgrid, "projektid": projektid, "datum": datum});
			var loggwrapper = document.getElementById('loggwrapper');
				removechilds(loggwrapper);
		};
		socket.on('reloadlogg', function(loggdata) {
			showhide('loggedit', 'loggwrapper');
			showhide('projekt', 'loggwrapper');
			getlogg(loggdata.datum);
		});
		function showedit(element){
			var wrapper = document.getElementById('loggedit');
			var datatofetch = ['milisecin', 'milisecut', 'vgrid', 'projektid'];
			var datatopaste = {};
			for (var i = datatofetch.length - 1; i >= 0; i--) {
				var getdata = element.parentElement.parentElement.getAttribute('data-' + datatofetch[i]);
				datatopaste[datatofetch[i]] = getdata;
				wrapper.setAttribute('data-' + datatofetch[i], getdata);
			};
			var tidin = getDate('', '', datatopaste.milisecin);
			var tidut = getDate('', '', datatopaste.milisecut);
			document.getElementById('loggeditindat').value = tidin.datum;
			document.getElementById('loggeditintime').value = tidin.tid;
			document.getElementById('loggeditutdat').value = tidut.datum;
			document.getElementById('loggedituttime').value = tidut.tid;
			showhide('loggwrapper', 'loggedit');
		};
		function sendedit(){
			var loggeditindat = document.getElementById('loggeditindat').value;
			var loggeditintime = document.getElementById('loggeditintime').value;
			var tidin = getDate(loggeditindat, loggeditintime, '');
			var loggeditutdat = document.getElementById('loggeditutdat').value;
			var loggedituttime = document.getElementById('loggedituttime').value;
			var tidut = getDate(loggeditutdat, loggedituttime, '');
			if(tidin.milisec <= tidut.milisec){
				var wrapper = document.getElementById('loggedit');
				var arraytosave = {};
					arraytosave.vgrid = wrapper.getAttribute('data-vgrid');
					arraytosave.projektid = wrapper.getAttribute('data-projektid');
					arraytosave.old = {};
					arraytosave.old.millisecin = wrapper.getAttribute('data-milisecin');
					arraytosave.old.millisecut = wrapper.getAttribute('data-milisecut');
					var olddatumarray = getDate('', '', wrapper.getAttribute('data-milisecin'));
					arraytosave.old.datum = olddatumarray.datum;
					arraytosave.ny = {};
					arraytosave.ny.in = tidin;
					arraytosave.ny.ut = tidut;
				socket.emit('editsegment', arraytosave);
			}else{
				console.log('Tid är negativ!');
			};
		};
		function avbrytedit(){
			var datatoremove = ['milisecin', 'milisecut', 'vgrid', 'projektid'];
			var wrapper = document.getElementById('loggedit');
			for (var i = datatoremove.length - 1; i >= 0; i--) {
				wrapper.removeAttribute('data-' + datatoremove[i]);
			};
			document.getElementById('loggeditindat').value = '';
			document.getElementById('loggeditintime').value = '';
			document.getElementById('loggeditutdat').value = '';
			document.getElementById('loggedituttime').value = '';
			showhide('loggedit', 'loggwrapper');
		};

		function loadskrivut(){
			var vgrid = document.getElementById('tid').getAttribute('data-vgrid');
			var skrivutwrapper = document.getElementById('skrivut');
			removechilds(skrivutwrapper);
			socket.emit('getfilestoload', vgrid);
		};
		socket.on('responsfilestoload', function(data) {
			var skrivutwrapper = document.getElementById('skrivut');
				var tillbaka = document.createElement('input');
					tillbaka.setAttribute('type', 'button');
					tillbaka.setAttribute('value', 'Tillbaka');
					tillbaka.setAttribute('onclick', 'showhide("skrivut", "projekt");');
				skrivutwrapper.appendChild(tillbaka);
				//addbrake(skrivutwrapper);
				var checkboxwrapper = document.createElement('div');
					checkboxwrapper.setAttribute('id', 'printcheckboxes');
				for (var a = data.responsdata.length - 1; a >= 0; a--) {
					var span = document.createElement('span');
						span.setAttribute('class', 'checkboxwrapper');
						var input = document.createElement('input');
							input.setAttribute('type', 'checkbox');
							input.setAttribute('data-namn', data.responsdata[a]);
							input.checked = true;
						span.appendChild(input);
						var lable = document.createElement('lable');
							var labletext = document.createTextNode(config.projekt[data.responsdata[a]].namn);
							lable.appendChild(labletext);
						span.appendChild(lable);
					checkboxwrapper.appendChild(span);
				};
				skrivutwrapper.appendChild(checkboxwrapper);
				addbrake(skrivutwrapper);
				var select = document.createElement('select');
					select.setAttribute('id', 'skrivutdatum');
				skrivutwrapper.appendChild(select);
				var skapa = document.createElement('input');
					skapa.setAttribute('type', 'button');
					skapa.setAttribute('value', 'Skriv ut...');
					skapa.setAttribute('onclick', 'startprint();');
				skrivutwrapper.appendChild(skapa);
			socket.emit('getdates', {"vgrid": data.vgrid, "responsdata": data.responsdata});
			showhide('projekt', 'skrivut');
		});
		socket.on('skrivutadddatum', function(datum) {
			var wrapper = document.getElementById('skrivutdatum');
			var newoptions = [];
			var alloptions = wrapper.getElementsByTagName('option');
			for (var a = alloptions.length - 1; a >= 0; a--) {
				newoptions.push(alloptions[a].getAttribute('value'));
			};
			removechilds(wrapper);
			for (var i = datum.length - 1; i >= 0; i--) {
				var nyval = true;
				for (var a = newoptions.length - 1; a >= 0; a--) {
					if(newoptions[a] == datum[i]){
						var nyval = false;
					};
				};
				if(nyval){
					newoptions.push(datum[i]);
				};
			};
			newoptions.sort();
			for (var i = newoptions.length - 1; i >= 0; i--) {
				var option = document.createElement('option');
					option.setAttribute('value', newoptions[i]);
					var optiontext = document.createTextNode(newoptions[i]);
					option.appendChild(optiontext);
				wrapper.appendChild(option);
			};
		});
		//#skrivutpapper
		function startprint(){
			var vgrid = document.getElementById('tid').getAttribute('data-vgrid');
			var manad = document.getElementById('skrivutdatum').value;
			var allcheckboxes = document.getElementById('printcheckboxes').getElementsByTagName('input');
			var projekttoget = [];
			for (var i = allcheckboxes.length - 1; i >= 0; i--) {
				if(allcheckboxes[i].getAttribute('type') == 'checkbox'){
					if(allcheckboxes[i].checked == true){
						projekttoget.push(allcheckboxes[i].getAttribute('data-namn'));
					};
				};
			};
			var skrivutpapper = document.getElementById('skrivutpapper');
				removechilds(skrivutpapper);
				var head = document.createElement('h2');
					var headtext = document.createTextNode('Tidrapport för: ' + manad);
					head.appendChild(headtext);
				skrivutpapper.appendChild(head);
				var table = document.createElement('table');
					var thead = document.createElement('thead');
						var theadtr = document.createElement('tr');
						for (var i = 0; i < config.forklaringar.length; i++){
							var theadtd = document.createElement('td');
								var theadtdtext = document.createTextNode(config.forklaringar[i]);
								theadtd.appendChild(theadtdtext);
							theadtr.appendChild(theadtd);
						};
						thead.appendChild(theadtr);
					table.appendChild(thead);
					var tbody = document.createElement('tbody');
					table.appendChild(tbody);
				skrivutpapper.appendChild(table);
			socket.emit('getprojektinformaiton', {"vgrid": vgrid, "manad": manad, "projekttoget": projekttoget});
		};
		socket.on('skrivutinfo', function(respons) {
			for (var i = respons.length - 1; i >= 0; i--) {
				if(respons[i].data == 'none'){
					addskrivutline(respons[i].id, config.skrivutfinnsinte);
				}else if(respons[i].data.length == 0){
					addskrivutline(respons[i].id, config.skrivutfinnsinte);
				}else{
					var loggsorted = loggsort(respons[i].data);
					for (var a = 0; a < loggsorted.length; a++){
						if(!loggsorted[a].ut){}else{
							var time = timebetween(loggsorted[a].in.milisec, loggsorted[a].ut.milisec, '');
							var printarray = [loggsorted[a].in.tid, loggsorted[a].ut.tid, addzero(time.t) + ':' + addzero(time.m) + ':' + addzero(time.s)];
							addskrivutline(respons[i].id, printarray, loggsorted[a]);
						};
					};
				};
			};
			countallpassskrivut();
			window.print();
		});
		function adddagskrivut(element, namn, datum){
			var dagnummertd = document.createElement('td');
				dagnummertd.setAttribute('rowspan', '1');
				dagnummertd.setAttribute('class', namn);
				var comprimdat = datum.slice(2).split('-').join('');
				var dagnummertdtext = document.createTextNode(comprimdat);
				dagnummertd.appendChild(dagnummertdtext);
			element.appendChild(dagnummertd);
		};
		function addskrivutline(projektid, array, data){
			var table = document.getElementById('skrivutpapper').getElementsByTagName('table')[0].getElementsByTagName('tbody')[0];
				var oldtr = table.getElementsByClassName(projektid);
				var tr = document.createElement('tr');
					tr.setAttribute('class', projektid);
				if(oldtr.length == 0){
					tr.setAttribute('class', projektid + ' topborder');
					var projekttd = document.createElement('td');
						projekttd.setAttribute('rowspan', '1');
						projekttd.setAttribute('class', 'projektnamn');
						var projekttdtext = document.createTextNode(config.projekt[projektid].namn);
						projekttd.appendChild(projekttdtext);
					tr.appendChild(projekttd);
					if(!data){}else{
						adddagskrivut(tr, projektid + 'dagnummer' + data.in.datum, data.in.datum);
					};
				}else{
					oldtr[0].firstChild.setAttribute('rowspan', parseInt(oldtr[0].firstChild.getAttribute('rowspan')) + 1);
					if(!data){}else{
						var dagnummertd = oldtr[0].getElementsByClassName(projektid + 'dagnummer' + data.in.datum);
						if(dagnummertd.length == 0){
							adddagskrivut(tr, projektid + 'dagnummer' + data.in.datum, data.in.datum);
						}else{
							dagnummertd[0].setAttribute('rowspan', parseInt(dagnummertd[0].getAttribute('rowspan')) + 1);
						};
					};
				};
				for (var i = 0; i < array.length; i++){
					var td = document.createElement('td');
						var tdtext = document.createTextNode(array[i]);
						td.appendChild(tdtext);
					tr.appendChild(td);
				};
				if(!data){}else{
					var countmilisec = parseInt(data.ut.milisec) - parseInt(data.in.milisec);
					if(oldtr.length == 0){
						nytimeskrivut(tr, projektid + 'dagcount' + data.in.datum, countmilisec);
						nytimeskrivut(tr, projektid + 'passcount passcount', countmilisec);
					}else{
						var countforday = oldtr[0].getElementsByClassName(projektid + 'dagcount' + data.in.datum);
						if(countforday.length == 0){
							nytimeskrivut(tr, projektid + 'dagcount' + data.in.datum, countmilisec);
						}else{
							updattimeskrivut(countforday, countmilisec);
						};
						var countforpass = oldtr[0].getElementsByClassName(projektid + 'passcount');
						updattimeskrivut(countforpass, countmilisec);
					};
				};
				table.appendChild(tr);
		};
		function nytimeskrivut(element, namn, countmilisec){
			var nytime = timebetween('', '', countmilisec);
			var daycounttd = document.createElement('td');
				daycounttd.setAttribute('rowspan', '1');
				daycounttd.setAttribute('class', namn);
				daycounttd.setAttribute('data-milisec', countmilisec);
				var daycounttdtdtext = document.createTextNode(addzero(nytime.t) + ':' + addzero(nytime.m) + ':' + addzero(nytime.s));
				daycounttd.appendChild(daycounttdtdtext);
			element.appendChild(daycounttd);
		};
		function updattimeskrivut(allelem, countmilisec){
			var nymilisec = parseInt(allelem[0].getAttribute('data-milisec')) + countmilisec;
			var time = timebetween('', '', nymilisec);
			allelem[0].setAttribute('rowspan', parseInt(allelem[0].getAttribute('rowspan')) + 1);
			allelem[0].setAttribute('data-milisec', nymilisec);
			removechilds(allelem[0]);
			var daycounttdtdtext = document.createTextNode(addzero(time.t) + ':' + addzero(time.m) + ':' + addzero(time.s));
			allelem[0].appendChild(daycounttdtdtext);
		};
		function countallpassskrivut(){
			var table = document.getElementById('skrivutpapper').getElementsByTagName('table')[0].getElementsByTagName('tbody')[0];
			var allpasscount = table.getElementsByClassName('passcount');
			var millisec = 0;
			for (var i = allpasscount.length - 1; i >= 0; i--) {
				var millisec = millisec + parseInt(allpasscount[i].getAttribute('data-milisec'));
			};
			var time = timebetween('', '', millisec);
			var firsttr = table.getElementsByTagName('tr');
				var allpasstd = document.createElement('td');
					allpasstd.setAttribute('rowspan', firsttr.length);
					var allpasstext = document.createTextNode(addzero(time.t) + ':' + addzero(time.m) + ':' + addzero(time.s));
					allpasstd.appendChild(allpasstext);
				firsttr[0].appendChild(allpasstd);
		};
	</script>
</body>
</html>